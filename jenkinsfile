node {
   // Mark the code checkout 'stage'....
   echo 'Hello from jenkinsfile'
   stage 'Checkout'

   // Get some code from a GitHub repository
   //git url: 'https://github.com/Labdoui/PPIV.git'
   git url: 'git@candelo.socrate.vsct.fr:PPIV_team/PPIV.git', branch: 'master'


    //Cleaning stage
    stage('Cleanup') {
       sh "sbt clean"
    }

    // Analysis by sonar
    stage('coverage') {
       sh "sbt coverage"
    }

    //test stage
    stage('test') {
       sh "sbt test"
    }

    //Cleaning stage
    stage('report') {
        sh "sbt coverageReport"
    }

    //Quality Gates
    stage('sonar') {
        sh "export http_proxy= && export https_proxy= && sbt sonar"
    }

    //Cleaning stage
    stage('assembly') {
        sh "sbt assembly"
    }

    //Deploy Nexus
    stage('publish Nexus') {
        sh "export http_proxy= && export https_proxy= && sbt publish"
    }

    //Deploy Nexus
    stage('publish VM') {
        def version = sh returnStdout: true, script: "curl --silent 'https://nexus.bigdatasncf.sncf.fr/service/local/lucene/search?g=ppiv&a=ppiv_2.10&repositoryId=snapshots' | sed -n 's|<latestSnapshot>(.*)</latestSnapshot>|1|p' | sed -e 's/^[ \t]*//' | tail -1"        sh "echo $VERSION"
        echo "Version du snpashot : ${version}"
    }




    echo 'End packaging'
 }
